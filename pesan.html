<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Messages - COMRIGHT 379</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        :root { --gold: #d4af37; --bg-dark: #050505; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        html, body { height: 100%; width: 100%; background: var(--bg-dark); color: white; overflow: hidden; position: fixed; }
        body { display: flex; flex-direction: column; }

        header { padding: 15px; border-bottom: 1px solid #222; text-align: center; background: #000; flex-shrink: 0; position: relative; }

        /* --- AUDIO NAV SEBELAH KIRI --- */
        .audio-nav { position: absolute; left: 70px; top: 50%; transform: translateY(-50%); display: flex; align-items: center; gap: 8px; cursor: pointer; }
        .visualizer { display: flex; align-items: flex-end; gap: 2px; height: 15px; }
        .bar { width: 3px; background: var(--gold); border-radius: 1px; height: 3px; }
        .bar.animate { animation: bounce 0.8s infinite alternate; }
        .bar:nth-child(2) { animation-delay: 0.2s; }
        .bar:nth-child(3) { animation-delay: 0.4s; }
        .bar:nth-child(4) { animation-delay: 0.6s; }
        @keyframes bounce { 0% { height: 3px; } 100% { height: 15px; } }

        /* --- CHAT AREA --- */
        #chat-container { 
            flex: 1; overflow-y: auto; padding: 20px; 
            display: flex; flex-direction: column; gap: 12px; 
            background: #050505; -webkit-overflow-scrolling: touch; 
        }

        .message-wrapper { display: flex; flex-direction: column; position: relative; cursor: pointer; }

        .message-bubble {
            max-width: 85%; padding: 10px 15px; border-radius: 18px;
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            align-self: flex-start; transition: 0.2s;
        }

        .my-message { align-self: flex-end; border-color: var(--gold); background: rgba(212, 175, 55, 0.1); }

        .reply-in-bubble {
            background: rgba(0,0,0,0.4); border-left: 3px solid var(--gold);
            padding: 5px 10px; border-radius: 8px; margin-bottom: 5px; font-size: 11px; color: #999;
        }

        #reply-preview {
            display: none; background: #111; padding: 10px 20px;
            border-top: 1px solid var(--gold); border-left: 5px solid var(--gold);
            justify-content: space-between; align-items: center; flex-shrink: 0;
        }

        .sender-name { color: var(--gold); font-size: 10px; font-weight: 600; text-transform: uppercase; margin-bottom: 2px; display: block; }
        .text-content { font-size: 14px; color: #eee; word-wrap: break-word; }
        .timestamp { font-size: 8px; color: #555; display: block; margin-top: 4px; text-align: right; }

        .input-area { 
            padding: 10px 15px; background: #0a0a0a; border-top: 1px solid #222; 
            display: flex; gap: 10px; align-items: center; flex-shrink: 0;
            padding-bottom: env(safe-area-inset-bottom, 10px);
        }

        #message-input { 
            flex: 1; background: #1a1a1a; border: 1px solid #333; 
            padding: 12px 18px; border-radius: 25px; color: white; 
            font-size: 16px; outline: none; 
        }

        .send-btn { 
            background: var(--gold); width: 45px; height: 45px; border-radius: 50%; 
            border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; 
        }
    </style>
</head>
<body>

    <audio id="bgMusic" loop>
        <source src="kisah klasik.mp3" type="audio/mpeg">
    </audio>

    <header>
        <a href="main.html" style="position: absolute; left: 15px; color: var(--gold); text-decoration: none; font-size: 12px;">← BACK</a>
        
        <div class="audio-nav" id="musicToggle">
            <div class="visualizer">
                <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
            </div>
        </div>

        <span style="color: var(--gold); font-weight: bold; font-size: 14px;">COMRIGHT 379 CHAT</span>
    </header>

    <div id="chat-container"></div>

    <div id="reply-preview">
        <div style="overflow: hidden;">
            <div id="reply-name" style="font-size: 11px; color: var(--gold); font-weight: bold;"></div>
            <div id="reply-text" style="font-size: 13px; color: #ccc; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"></div>
        </div>
        <button onclick="cancelReply()" style="background:none; border:none; color:#ff5555; font-size: 22px; cursor:pointer; padding-left:10px;">×</button>
    </div>

    <div class="input-area">
        <input type="text" id="message-input" placeholder="Tulis pesan..." autocomplete="off">
        <button class="send-btn" onclick="sendMessage()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="black"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
        </button>
    </div>

    <script>
        // --- LOGIKA MUSIK & VISUALIZER (PENYAMBUNG ALUNAN) ---
        const music = document.getElementById('bgMusic');
        const musicBtn = document.getElementById('musicToggle');
        const bars = document.querySelectorAll('.bar');

        function updateVisualizer(playing) {
            bars.forEach(bar => {
                if (playing) bar.classList.add('animate');
                else bar.classList.remove('animate');
            });
        }

        window.addEventListener('load', () => {
            const savedTime = localStorage.getItem('musicTime');
            const isPlaying = localStorage.getItem('musicPlaying');

            if (savedTime) music.currentTime = parseFloat(savedTime);
            if (isPlaying === 'true') {
                music.play().then(() => {
                    updateVisualizer(true);
                }).catch(() => {
                    document.addEventListener('click', () => {
                        if(localStorage.getItem('musicPlaying') === 'true' && music.paused) {
                            music.play();
                            updateVisualizer(true);
                        }
                    }, { once: true });
                });
            }
        });

        setInterval(() => {
            if (!music.paused) {
                localStorage.setItem('musicTime', music.currentTime);
            }
        }, 500);

        musicBtn.addEventListener('click', () => {
            if (music.paused) {
                music.play();
                updateVisualizer(true);
                localStorage.setItem('musicPlaying', 'true');
            } else {
                music.pause();
                updateVisualizer(false);
                localStorage.setItem('musicPlaying', 'false');
            }
        });

        // --- FIREBASE SETUP ---
        const firebaseConfig = {
            apiKey: "AIzaSyALj_Gcwf_jwow1MPVZ0_xpTvvyB_bwEXo",
            authDomain: "comright379.firebaseapp.com",
            databaseURL: "https://comright379-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "comright379",
            storageBucket: "comright379.firebasestorage.app",
            messagingSenderId: "602850111912",
            appId: "1:602850111912:web:1372097fa168af0668ad9d"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let senderName = localStorage.getItem('alumni_name') || "Guest";
        let replyData = null;

        function loadMessages() {
            db.ref('messages').limitToLast(50).on('value', (snapshot) => {
                const container = document.getElementById('chat-container');
                container.innerHTML = "";
                snapshot.forEach((child) => {
                    const d = child.val();
                    const isMe = d.name === senderName ? "my-message" : "";
                    let replyHTML = d.replyTo ? `<div class="reply-in-bubble"><b>${d.replyTo.name}</b><br>${d.replyTo.text}</div>` : "";

                    const wrapper = document.createElement('div');
                    wrapper.className = 'message-wrapper';
                    wrapper.onclick = () => setReply(d.name, d.text);
                    wrapper.addEventListener('touchstart', (e) => handleTouchStart(e, d.name, d.text), {passive: true});
                    wrapper.addEventListener('touchend', (e) => handleTouchEnd(e), {passive: true});

                    wrapper.innerHTML = `
                        <div class="message-bubble ${isMe}">
                            <span class="sender-name">${d.name}</span>
                            ${replyHTML}
                            <div class="text-content">${d.text}</div>
                            <span class="timestamp">${d.time}</span>
                        </div>
                    `;
                    container.appendChild(wrapper);
                });
                container.scrollTop = container.scrollHeight;
            });
        }

        let touchStartX = 0;
        let activeReplyCandidate = null;
        function handleTouchStart(e, name, text) { touchStartX = e.touches[0].clientX; activeReplyCandidate = { name, text }; }
        function handleTouchEnd(e) {
            let touchEndX = e.changedTouches[0].clientX;
            if (touchEndX - touchStartX > 60 && activeReplyCandidate) { setReply(activeReplyCandidate.name, activeReplyCandidate.text); }
        }

        function setReply(name, text) {
            replyData = { name, text };
            document.getElementById('reply-preview').style.display = 'flex';
            document.getElementById('reply-name').innerText = "Membalas " + name;
            document.getElementById('reply-text').innerText = text;
            document.getElementById('message-input').focus();
        }

        function cancelReply() {
            replyData = null;
            document.getElementById('reply-preview').style.display = 'none';
        }

        function sendMessage() {
            const input = document.getElementById('message-input');
            const msg = input.value.trim();
            if (msg !== "") {
                db.ref('messages').push({
                    name: senderName,
                    text: msg,
                    replyTo: replyData,
                    time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                    timestamp: Date.now()
                });
                input.value = "";
                cancelReply();
            }
        }

        const inputField = document.getElementById('message-input');
        inputField.addEventListener('keydown', (e) => {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        inputField.addEventListener('focus', () => {
            setTimeout(() => {
                document.getElementById('chat-container').scrollTop = document.getElementById('chat-container').scrollHeight;
            }, 300);
        });

        loadMessages();
    </script>
</body>
</html>
